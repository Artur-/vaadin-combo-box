<link rel="import" href="../polymer/polymer.html">

<dom-module id="vaadin-overlay">
  <template>
    <style>
      :host {
          position: absolute;
          @apply --shadow-elevation-2dp;
          background: #fff;
          border-radius: 0 0 2px 2px;
          top: 0;
          left: 0;
          pointer-events: auto;

          /**
          * Keep the vaadin-combo-box-overlay above paper-dialogs.
          * iron-overlay-manager.html: Polymer.IronOverlayManagerClass.prototype._applyOverlayZ
          */
          z-index: 200;
          overflow: hidden;
        }
      </style>
    <slot></slot>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'vaadin-overlay',

    behaviors: [Polymer.Templatizer],

    properties: {
      opened: {
        type: Boolean,
        reflectToAttribute: true
      },

      template: {
        notify: true,
        value: function() {
          return Polymer.dom(this).querySelector('template') || undefined;
        }
      },

      _instance: Object
    },

    observers: ['_openedChanged(opened)', '_templateChanged(template)'],

    _openedChanged: function(opened) {
      if (opened) {
        // should be a comment node instead of element?
        this._placeholder = document.createElement('div');
        this.parentNode.insertBefore(this._placeholder, this);
        document.body.appendChild(this);
      } else if(this._placeholder) {
        this._placeholder.parentNode.insertBefore(this, this._placeholder);
        this._processPendingMutationObserversFor(document.body);
        this._placeholder.parentNode.removeChild(this._placeholder);
      }
    },

    _templateChanged: function(template) {
      this.templatize(template);
      this._instance = this.stamp();
      this.root.appendChild(this._instance.root);
    },

    _forwardHostPropV2: function(prop, value) {
      if (this._instance) {
        this._instance.set(prop, value);
      }
    },

    _processPendingMutationObserversFor: function(node) {
      if (window.CustomElements && !Polymer.Settings.useNativeCustomElements) {
        CustomElements.takeRecords(node);
      }
    }
  });
</script>